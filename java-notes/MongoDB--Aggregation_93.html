<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Aggregation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Aggregation</h1><br/><p></p><p>Агрегация.</p><p></p><p>Агрегация – это группировка значений многих документов. Операции агрегирования позволяют манипулировать такими сгруппированными данными (например, подсчёт – COUNT(*)). В MySQL аналогом агрегации является команда group by.</p><p></p><p>В MongoDB для агрегации используется метод aggregate():</p><p></p><p>db.ИМЯ_КОЛЛЕКЦИИ.aggregate(ОПЕРАЦИЯ_АГРЕГАЦИИ)</p><p></p><p>Пример:</p><p></p><p>Вычислить общую зарплату всех разработчиков в коллекции:</p><p></p><p><strong>db.developers.find().pretty()</strong></p><p></p><p>{</p><p>	&quot;_id&quot; : ObjectId(&quot;5815f4e735ee883c37ac8b4d&quot;),</p><p>	&quot;title&quot; : &quot;Eugene Suleimanov&quot;,</p><p>	&quot;specialty&quot; : &quot;Java&quot;,</p><p>	&quot;skills&quot; : [</p><p>		&quot;Java&quot;,</p><p>		&quot;Hibernate&quot;,</p><p>		&quot;Spring&quot;</p><p>	],</p><p>	&quot;salary&quot; : 3500</p><p>}</p><p></p><p><strong>db.developers.aggregate( [ {$group :{ _id : &quot;Developers&quot;, total_salary: { $sum : &quot;$salary&quot; }}} ] )</strong></p><p></p><p>{ &quot;_id&quot; : &quot;Developers&quot;, &quot;total_salary&quot; : 10500 }<code></code></p><p><code></code></p><p>Список операций для агрегации документов:</p><p><table class="table"><tr><th>Выраженеие</th><th>Описание</th><th>Пример</th></tr><tr><td>$sum</td><td>Суммирует указанные значения всех документов в коллекции.</td><td>db.ИМЯ_КОЛЛЕКЦИИ.aggregate([{$group : {_id : “$title”, total_salary : {$sum : “$salary”}}}])</td></tr><tr><td>$avg</td><td>Рассчитывает среднее значение указанного поля поля для всех документов коллекции.</td><td>db.ИМЯ_КОЛЛЕКЦИИ.aggregate([{$group : {_id : “$title”, avg_salary : {$avg : “$salary”}}}])</td></tr><tr><td>$min</td><td>Получает минимальное значение указанного поля документа в коллекции</td><td>db.ИМЯ_КОЛЛЕКЦИИ.aggregate([{$group : {_id : “$title”, min_salary : {$min : “$salary”}}}])</td></tr><tr><td>$max</td><td>Получает максимальное значение указанного поля документа в коллекции</td><td>db.ИМЯ_КОЛЛЕКЦИИ.aggregate([{$group : {_id : “$title”, max_salary : {$max : “$salary”}}}])</td></tr><tr><td>$push</td><td>Вставляет значение в массив в результирующем документе.</td><td>db.ИМЯ_КОЛЛЕКЦИИ.aggregate([{$group : {_id : “$title”, skills : {$push: “$skills”}}}])</td></tr><tr><td>$addToSet</td><td>Вставляет значение в массив в результирующем документе, но не создаёт дубликаты.</td><td>db.ИМЯ_КОЛЛЕКЦИИ.aggregate([{$group : {_id : “$title”, skills : {$addToSet : “$skills”}}}])</td></tr><tr><td>$first</td><td>Получает первый документ из сгруппированных. Обычно используется вместе с сортировкой.</td><td>db.ИМЯ_КОЛЛЕКЦИИ.aggregate([{$group : {_id : “$title”, first_skill : {$first : “$skills”}}}])</td></tr><tr><td>$last</td><td>Получает крайний документ из сгруппированных. Обычно используется вместе с сортировкой.</td><td>db.ИМЯ_КОЛЛЕКЦИИ.aggregate([{$group : {_id : “$title”, last_skill : {$last : “$skills”}}}])</td></tr></table></p><p></p><p>Концепция “Трубопровода”</p><p>В UNIX-системах данная концепция означает возможность выполнения операции над некоторым вводом и использования вывода, как ввода для следующей команды. MongoDB также поддерживает данную концепцию. Ниже приведён список возможных этапов и каждый из них может быть взят, как множество документов для ввода и сгенерировать  набор документов, полученных в результате обработки:</p><p></p><p>• <strong>$project</strong> - Используется для выбора некоторых специальных полей из коллекции.</p><p>• <strong>$match</strong> - Операция фильтрации, которая может уменьшить количество документов, которые передаются для ввода в следующий этап.</p><p>• <strong>$group</strong> - Непосредственно, сама агрегация</p><p>• <strong>$sort</strong> - Сортирует документы</p><p>• <strong>$skip</strong> - С помощью данной команды мы можем проигнорировать список документов в имеющемся множестве.</p><p>• <strong>$limit</strong> - Ограничивает количество документов для вывода на количество, переданное методу, начиная, с текущей позиции.</p><p>• <strong>$unwind</strong> - Используется для “разматывания” документов, который используют массивы.</p><p></p><p></p><p></p><p></p></div>
</body>
</html>
