<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Docker</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Docker</h1><br/><p>Docker - система виртуализации (урезанная виртуальная машина). Виртуализация нужна чтобы не плодить на реальном рабочем столе много компьютеров. Виртуализация помогает экономить ресурсы, уменьшается время разработки, помогает покрыть проблему безопасности.</p><p>Docker тоже создает виртуальную машину, но ограниченную. Он не может на Linux запустит Windows. Ограничен тем, что не все операционные системы может виртуализировать, все виртуальные машины (image) для Docker делаются под Линукс. Docker хуже работает с файловой системой (у него нет своего жесткого диска). Стараются делать так, чтобы минимум было работы с файловой системой. Если требуется работа с файловой системой (большое обращение к диску), то можно сделать переброску своей рабочей папки (замапить) внутрь Линукс.</p><p>Docker может использоваться на всех этапах разработки CI/CD (во время разработки, тестирования, deployment, operations&amp;maintenance)</p><p>Docker - Write one, run anywhere</p><p></p><p>Docker состоит из:</p><p>файл “Dockerfile”:</p><p>Docker image (как готовое приложение) = Build Dockerfile. Помещается в локальное Docker-хранилище, можно отправить в удаленный репозиторий (Docker hub). Docker image можно запустить где угодно.</p><p>Container - запущенный Docker image</p><p></p><p>SDLC of Docker</p><p>- Write Dockerfile - прописываем какой взять за основу другой Docker image, чтобы не писать все с нуля. Как правило берется какой-то вид Линукса или вид другого Dockerfile с установленными Maven или JDK. Пишется: скопировать jar-файл, добавить инструкции, переменные</p><p>- Build Image from Dockerfile</p><p>- Upload Image to docker registry(репозиторий) (Docker hub)</p><p>- Download Image from repository</p><p>- Start Container (set ports, network, mapping file system, etc.) Во время работы контенера можно присоединиться к нему и запустить еще команды, смотреть логи</p><p>- Run a command into the Container</p><p>- Stop Container</p><p>- Parse (investigate) the logs</p><p></p><p>Dockerfile состоит из секций (команд):</p><p>- FROM (команда вызывается 1 раз) (Если в Dockerfile несколько аннотаций FROM, то после начала другого FROM предыдущее забывается)</p><p>- COPY</p><p>- RUN</p><p>- CMD</p><p>- WORKDIR</p><p>- ENTRYPOINT [&quot;&quot;, &quot;&quot;, &quot;&quot;] - что вызовется, когда запускается Docker container</p><p>Файл “Dockerfile” (помещается в корневую папку модуля(проекта)):</p><p><div class="codebox"><pre>FROM openjdk:17-alpine //С какого похожего образа должны стартовать наш image. openjdk:17-alpine (готовый образ Линукса с JDK внутри)- готовый на Docker hub образ. Образы можно увидеть на https://hub.docker.com/<br /><br />//помещаем в папку модуля приложение(src) и pom-файл<br />//билдим наш модуль, получаем Lesson-09-1.0-SNAPSHOT.jar<br />ENV JAR_FILE=Lesson-09-1.0-SNAPSHOT.jar //переменная JAR_FILE<br />WORKDIR /root //work directory<br />COPY ./target/$JAR_FILE . //копируем наш jar файл в work directory<br />// директория в нашей файловой системе &quot;./target/$JAR_FILE&quot;<br />// текущая директория на имидже &quot;.&quot;<br /><br />EXPOSE 9090 //порт, на котором будет работать<br /><br />ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;Lesson-09-1.0-SNAPSHOT.jar&quot;]     <br />//Указываем какбудет запускаться (в этом запуске переменная не работает)</pre></div></p><p>Перед запуском mvn clean install; должно быть 2 jar файла (оригинальный и от Spring Boot)</p><p>Прежде чем заливать в Docker, проверить в командной строке запускается ли приложение локально: java -jar Lesson-09-1.0-SNAPSHOT.jar</p><p>Имидж можно сделать из контейнера (сделать слепок)</p><p>Переходим в директорию, где Dockerfile, билдим имидж (&quot;.&quot; - текущая директория):</p><p>docker build -t lesson-09 . </p><p>Docker Image должен быть по возможности минимальный, там должен быть только файл для запуска, ничего лишнего. В Docker ложится только готовый продукт.</p><p>Сбилденный Image можно посмотреть в Docker-е во вкладке Image либо командой docker images.</p><p>Запустить Docker: docker run lesson-09</p><p></p><p>Docker commands:</p><p>- docker //вывод help</p><p>- docker --version //версия Docker</p><p>- docker build -t lesson-09 . //билд имиджа</p><p>- docker images //вывести список имиджей</p><p>- docker image ls //вывести список имиджей</p><p>- docker run lesson-09 //запуск (запускать с корня модуля lesson-09, т.е. где лежит Dockerfile)</p><p>- docker run --detach -p &lt;outside_port&gt;:&lt;inside_port&gt; lesson-09  //порт внутри  контейнера привязывается к реальному порту на компьютере</p><p>- docker container ls //вывести список запущенных контейнеров</p><p>- docker container ls --all //вывести список запущенных и незапущенных контейнеров</p><p>- docker container stop &lt;container id&gt;|&lt;container name&gt; //остановить контейнер, id и name взять из списка (docker container ls)</p><p>- docker pull &lt;image name&gt; //выкачка имиджа, например docker pull jenkins:2.60.3-alpine</p><p>//после скачивания имиджа запуск: docker run -p 8080:8080 -p 50000:50000 jenkins:2.60.3-alpine</p><p>- docker stop --time int (-t) Seconds to wait for stop before killing it (default 10)</p><p>- docker kill //остановить, если не получается остановить командой stop</p><p>- docker container rm &lt;container id&gt;|&lt;container name&gt; //удалить контейнер</p><p>- docker container prune //удалить все остановленные контейнеры</p><p>- docker image rm jenkins:2.60.3-alpine //удалить имидж</p><p>- docker logs &lt;container id&gt;|&lt;container name&gt; //логи внутри контейнера</p><p>- docker exec -it &lt;container&gt; sh //запуск команды внутри контейнера</p><p>//pwd - текущая директория docker контейнера</p><p>//ls -lah - содержимое директории</p><p>//ls -lah / - содержимое корневой директории</p><p>//df - проверить доступное пространство</p><p>//du - проверить размер занимаемый папками</p><p>//sh - зайти в командную строку контейнера (файл .ash_history - история команд, которые запускали внутри контейнера)</p><p>//echo sdf &gt; 123.txt - создать файл 123.txt с содержимым “sdf”</p><p>//cat 1.txt - вывести содержимое файла в командной строке</p><p>- docker push</p><p>        <span style="color:#6a8759;">docker login -u dvlytvynov -p 123456789</span></p><p><span style="color:#6a8759;">        docker image tag lesson-09:latest dvlytvynov/first_repo:latest</span></p><p><span style="color:#6a8759;">        </span><strong><span style="color:#6a8759;">docker image push</span></strong><span style="color:#6a8759;"> dvlytvynov/first_repo:latest</span></p><p><span style="color:#6a8759;">        docker logout</span></p><p><span style="color:#6a8759;">        docker images</span></p><p><span style="color:#6a8759;">        docker image rm lesson-09</span></p><p><span style="color:#6a8759;">        docker image rm dvlytvynov/first_repo</span></p><p><span style="color:#6a8759;">        docker images</span></p><p>- docker ps</p><p>- docker ps --all</p><p></p><p>Docker-compose управляет контейнерами, можно запустить несколько имиджей (для локального запуска)</p><p>docker-compose.yaml</p><p><div class="codebox"><pre>version: &#39;3.7&#39;<br />services:<br />  lesson-09:<br />    image: lesson-09<br />    ports:<br />      - &quot;33333:9090&quot;<br />  lesson-09-port4444:<br />    image: lesson-09<br />    ports:<br />      - &quot;44444:9090&quot;<br />    volumes:<br />        - ./frontend/src:/code/src //подключение файловых ресурсов<br />    depends_on:<br />        - lesson-09 //lesson-09-port4444 не запустится, пока не запустится lesson-09<br />        - ..... //можно добавить еще зависимости<br />  lesson-09-port5555:<br />    image: lesson-09<br />    ports:<br />      - &quot;55555:9090&quot; <br />    deploy:<br />        resources:<br />            limits:             //ограниыения по ресурсам<br />                cpus: &#39;0.60&#39;    //60% загрузки процессоров<br />                memory: 90M    <br />//запустится три экземпляра одного и того же приложения на разных портах</pre></div></p><p></p><p>Docker-compose commands</p><p>- docker-copmose --version</p><p>- docker-compose up --detach //запуск (--detach чтоб не держало консоль)</p><p>- docker-compose down //остановить</p><p>- docker-compose ps //список имиджей</p><p>- docker-compose logs //логи со всех контейнеров</p><p>- docker-compose pause</p><p>- docker-compose unpause</p><p>- docker-compose stop</p><p>- docker image rm name:tag  </p><p></p><p>Docker orchestration</p><p>- Kubernetes (k8s)</p><p>- OpenShift</p><p>- Portainer</p><p>- Heroku</p><p></p><p></p><p></p><p></p><p>      </p></div>
</body>
</html>
